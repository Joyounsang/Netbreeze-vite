<div class="tree-side type-edit">
  <ul class="tree-menu">
    <li class="tree-item">
      <a href="#" class="tree-link">
        테크노솔루션 : 부서코드 2
        <div class="hover-menu">
          <ul>
            <li>
              <div class="tree-btn"><span class="ico edit">수정</span></div>
            </li>
            <li>
              <div class="tree-btn"><span class="ico dissmiss">삭제</span></div>
            </li>
            <li>
              <div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div>
            </li>
          </ul>
        </div>
      </a>
      <ul class="tree-submenu">
        <li class="tree-item">
          <a href="#" class="tree-link">
            마케팅본부: 부서코드 2
            <div class="hover-menu">
              <ul>
                <li>
                  <div class="tree-btn"><span class="ico edit">수정</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico dissmiss">삭제</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div>
                </li>
              </ul>
            </div>
          </a>
          <ul class="tree-submenu">
            <li class="tree-item">
              <a href="#" class="tree-link">
                디지털마케팅팀
                <div class="hover-menu">
                  <ul>
                    <li>
                      <div class="tree-btn"><span class="ico edit">수정</span></div>
                    </li>
                    <li>
                      <div class="tree-btn"><span class="ico dissmiss">삭제</span></div>
                    </li>
                    <li>
                      <div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div>
                    </li>
                  </ul>
                </div>
              </a>
            </li>
            <li class="tree-item">
              <a href="#" class="tree-link">
                브랜드전략팀
                <div class="hover-menu">
                  <ul>
                    <li>
                      <div class="tree-btn"><span class="ico edit">수정</span></div>
                    </li>
                    <li>
                      <div class="tree-btn"><span class="ico dissmiss">삭제</span></div>
                    </li>
                    <li>
                      <div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div>
                    </li>
                  </ul>
                </div>
              </a>
            </li>
          </ul>
        </li>
        <li class="tree-item">
          <a href="#" class="tree-link">
            개발센터
            <div class="hover-menu">
              <ul>
                <li>
                  <div class="tree-btn"><span class="ico edit">수정</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico dissmiss">삭제</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div>
                </li>
              </ul>
            </div>
          </a>
          <ul class="tree-submenu">
            <li class="tree-item">
              <a href="#" class="tree-link">
                프론트엔드팀
                <div class="hover-menu">
                  <ul>
                    <li>
                      <div class="tree-btn"><span class="ico edit">수정</span></div>
                    </li>
                    <li>
                      <div class="tree-btn"><span class="ico dissmiss">삭제</span></div>
                    </li>
                    <li>
                      <div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div>
                    </li>
                  </ul>
                </div>
              </a>
            </li>
            <li class="tree-item">
              <a href="#" class="tree-link">
                백엔드팀
                <div class="hover-menu">
                  <ul>
                    <li>
                      <div class="tree-btn"><span class="ico edit">수정</span></div>
                    </li>
                    <li>
                      <div class="tree-btn"><span class="ico dissmiss">삭제</span></div>
                    </li>
                    <li>
                      <div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div>
                    </li>
                  </ul>
                </div>
              </a>
              <ul class="tree-submenu">
                <li class="tree-item">
                  <a href="#" class="tree-link">
                    API개발팀
                    <div class="hover-menu">
                      <ul>
                        <li>
                          <div class="tree-btn"><span class="ico edit">수정</span></div>
                        </li>
                        <li>
                          <div class="tree-btn"><span class="ico dissmiss">삭제</span></div>
                        </li>
                        <li>
                          <div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div>
                        </li>
                      </ul>
                    </div>
                  </a>
                </li>
                <li class="tree-item">
                  <a href="#" class="tree-link">
                    인프라팀
                    <div class="hover-menu">
                      <ul>
                        <li>
                          <div class="tree-btn"><span class="ico edit">수정</span></div>
                        </li>
                        <li>
                          <div class="tree-btn"><span class="ico dissmiss">삭제</span></div>
                        </li>
                        <li>
                          <div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div>
                        </li>
                      </ul>
                    </div>
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </li>
        <li class="tree-item">
          <a href="#" class="tree-link">
            인사총무팀
            <div class="hover-menu">
              <ul>
                <li>
                  <div class="tree-btn"><span class="ico edit">수정</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico dissmiss">삭제</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div>
                </li>
              </ul>
            </div>
          </a>
        </li>
      </ul>
    </li>
    <li class="tree-item">
      <a href="#" class="tree-link">
        글로벌컨설팅
        <div class="hover-menu">
          <ul>
            <li>
              <div class="tree-btn"><span class="ico edit">수정</span></div>
            </li>
            <li>
              <div class="tree-btn"><span class="ico dissmiss">삭제</span></div>
            </li>
            <li>
              <div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div>
            </li>
          </ul>
        </div>
      </a>
      <ul class="tree-submenu">
        <li class="tree-item">
          <a href="#" class="tree-link">
            기획팀
            <div class="hover-menu">
              <ul>
                <li>
                  <div class="tree-btn"><span class="ico edit">수정</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico dissmiss">삭제</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div>
                </li>
              </ul>
            </div>
          </a>
        </li>
        <li class="tree-item">
          <a href="#" class="tree-link">
            영업팀
            <div class="hover-menu">
              <ul>
                <li>
                  <div class="tree-btn"><span class="ico edit">수정</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico dissmiss">삭제</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div>
                </li>
              </ul>
            </div>
          </a>
        </li>
        <li class="tree-item">
          <a href="#" class="tree-link">
            고객지원팀
            <div class="hover-menu">
              <ul>
                <li>
                  <div class="tree-btn"><span class="ico edit">수정</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico dissmiss">삭제</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div>
                </li>
              </ul>
            </div>
          </a>
        </li>
        <li class="tree-item">
          <a href="#" class="tree-link">
            품질관리팀
            <div class="hover-menu">
              <ul>
                <li>
                  <div class="tree-btn"><span class="ico edit">수정</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico dissmiss">삭제</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div>
                </li>
              </ul>
            </div>
          </a>
        </li>
      </ul>
    </li>
    <li class="tree-item">
      <a href="#" class="tree-link">
        데이터인사이트
        <div class="hover-menu">
          <ul>
            <li>
              <div class="tree-btn"><span class="ico edit">수정</span></div>
            </li>
            <li>
              <div class="tree-btn"><span class="ico dissmiss">삭제</span></div>
            </li>
            <li>
              <div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div>
            </li>
          </ul>
        </div>
      </a>
      <ul class="tree-submenu">
        <li class="tree-item">
          <a href="#" class="tree-link">
            분석팀
            <div class="hover-menu">
              <ul>
                <li>
                  <div class="tree-btn"><span class="ico edit">수정</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico dissmiss">삭제</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div>
                </li>
              </ul>
            </div>
          </a>
        </li>
        <li class="tree-item">
          <a href="#" class="tree-link">
            연구개발팀
            <div class="hover-menu">
              <ul>
                <li>
                  <div class="tree-btn"><span class="ico edit">수정</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico dissmiss">삭제</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div>
                </li>
              </ul>
            </div>
          </a>
        </li>
        <li class="tree-item">
          <a href="#" class="tree-link">
            AI팀
            <div class="hover-menu">
              <ul>
                <li>
                  <div class="tree-btn"><span class="ico edit">수정</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico dissmiss">삭제</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div>
                </li>
              </ul>
            </div>
          </a>
        </li>
        <li class="tree-item">
          <a href="#" class="tree-link">
            빅데이터팀
            <div class="hover-menu">
              <ul>
                <li>
                  <div class="tree-btn"><span class="ico edit">수정</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico dissmiss">삭제</span></div>
                </li>
                <li>
                  <div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div>
                </li>
              </ul>
            </div>
          </a>
        </li>
      </ul>
    </li>
  </ul>
</div>

<script>

  $(document).ready(function () {
    treeMenuClickEvent();
    initTreeSortable();
  });

  // Drag and Drop 초기화 (type-edit 클래스가 있는 경우만)
  function initTreeSortable() {
    // 약간의 지연을 두고 초기화 (DOM이 완전히 로드된 후)
    setTimeout(function () {
      $('.tree-side.type-edit').each(function () {
        const $treeSide = $(this);

        // 모든 tree-menu와 tree-submenu에 sortable 적용
        function makeSortable($container) {
          $container.find('.tree-menu, .tree-submenu').each(function () {
            const $list = $(this);
            if (!$list.hasClass('ui-sortable')) {
              $list.sortable({
                items: '> .tree-item',
                handle: '.tree-link',
                cancel: '.hover-menu, .tree-btn, input, button, .tree-add-form, .tree-edit-form, .code',
                placeholder: 'ui-sortable-placeholder tree-item',
                tolerance: 'pointer',
                cursor: 'move',
                opacity: 0.6,
                connectWith: '.tree-side.type-edit .tree-menu, .tree-side.type-edit .tree-submenu',
                helper: 'clone',
                distance: 10, // 10px 이상 움직여야 드래그 시작
                delay: 0,
                start: function (event, ui) {
                  ui.placeholder.height(ui.item.height());
                  ui.placeholder.css('visibility', 'visible');
                  ui.placeholder.css('border', '2px dashed var(--rec-primary)');
                  ui.placeholder.css('background', 'rgba(0, 150, 255, 0.1)');
                  ui.placeholder.css('border-radius', '10px');
                },
                update: function (event, ui) {
                  // 드래그 완료 후 하위 메뉴도 다시 sortable 적용
                  refreshSortable($treeSide);
                }
              });
            }
          });
        }

        // 초기 sortable 적용
        makeSortable($treeSide);

        // 동적으로 추가된 항목에도 sortable 적용을 위한 함수
        window.refreshTreeSortable = function () {
          makeSortable($treeSide);
        };
      });
    }, 200);
  }

  // sortable 새로고침 함수
  function refreshSortable($container) {
    $container.find('.tree-menu, .tree-submenu').each(function () {
      const $list = $(this);
      if ($list.hasClass('ui-sortable')) {
        $list.sortable('refresh');
      }
    });
  }

  function treeMenuClickEvent() {

    // "하위에 항목추가" 버튼 클릭 이벤트
    $(document).on('click', '.tree-btn:has(.ico.added)', function (e) {
      e.stopPropagation();
      const $btn = $(this);
      const $treeItem = $btn.closest('.tree-item');
      let $submenu = $treeItem.children('.tree-submenu');

      // 하위 메뉴가 없으면 생성
      if ($submenu.length === 0) {
        $submenu = $('<ul class="tree-submenu"></ul>');
        $treeItem.append($submenu);
        $treeItem.addClass('has-children');
      }

      // 이미 입력 폼이 있으면 제거
      $submenu.find('.tree-add-form').remove();

      // 입력 폼 생성
      const $form = $('<li class="tree-item"><div class="tree-add-form show"><div class="form-input"><input type="text" placeholder="그룹명을 입력해주세요."><div class="form-buttons"><button class="btn-add">추가</button><button class="btn-cancel">취소</button></div></div></div></li>');
      $submenu.append($form);

      // 하위 메뉴 확장
      $treeItem.addClass('expanded');

      // 입력 필드에 포커스
      $form.find('input').focus();

      // 추가 버튼 클릭
      $form.find('.btn-add').on('click', function (e) {
        e.stopPropagation();
        const inputValue = $form.find('input').val().trim();
        if (inputValue) {
          // 새 항목 추가
          const $newItem = $('<li class="tree-item"><a href="#" class="tree-link">' + inputValue + '<div class="hover-menu"><ul><li><div class="tree-btn"><span class="ico edit">수정</span></div></li><li><div class="tree-btn"><span class="ico dissmiss">삭제</span></div></li><li><div class="tree-btn"><span class="ico added">추가</span>하위에 항목추가</div></li></ul></div></a></li>');
          $form.before($newItem);
          $form.remove();
          // sortable 새로고침
          if (window.refreshTreeSortable) {
            window.refreshTreeSortable();
          }
        }
      });

      // 취소 버튼 클릭
      $form.find('.btn-cancel').on('click', function (e) {
        e.stopPropagation();
        $form.remove();
      });

      // Enter 키 처리
      $form.find('input').on('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          $form.find('.btn-add').click();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          $form.find('.btn-cancel').click();
        }
      });
    });

    // 삭제 버튼 클릭 이벤트
    $(document).on('click', '.tree-btn:has(.ico.dissmiss)', function (e) {
      e.stopPropagation();
      const $btn = $(this);
      const $treeItem = $btn.closest('.tree-item');

      // 확인 후 삭제
      if (confirm('정말 삭제하시겠습니까?')) {
        $treeItem.remove();
      }
    });

    // 수정 버튼 클릭 이벤트
    $(document).on('click', '.tree-btn:has(.ico.edit)', function (e) {
      e.stopPropagation();
      const $btn = $(this);
      const $treeLink = $btn.closest('.tree-link');
      const $treeItem = $treeLink.closest('.tree-item');

      // 이미 수정 모드면 무시
      if ($treeItem.find('.tree-edit-form').length > 0) {
        return;
      }

      // tree-link의 텍스트 추출 (code와 hover-menu 제외)
      const $linkClone = $treeLink.clone();
      $linkClone.find('.hover-menu').remove();
      const $code = $linkClone.find('.code');
      const codeHtml = $code.length > 0 ? $code[0].outerHTML : '';
      $code.remove();
      const linkText = $linkClone.text().trim();

      // tree-link 숨기기
      $treeLink.hide();

      // 수정 폼 생성
      const $editForm = $('<div class="tree-edit-form show"><div class="form-input"><input type="text" value="' + $('<div>').text(linkText).html() + '"><div class="form-buttons"><button class="btn-add">수정</button><button class="btn-cancel">취소</button></div></div></div>');
      $treeLink.after($editForm);

      // 입력 필드에 포커스 및 전체 선택
      const $input = $editForm.find('input');
      $input.focus();
      $input.select();

      // 추가 버튼 클릭 (저장)
      $editForm.find('.btn-add').on('click', function (e) {
        e.stopPropagation();
        const inputValue = $input.val().trim();
        if (inputValue) {
          // tree-link의 모든 텍스트 노드 제거
          $treeLink.contents().each(function () {
            if (this.nodeType === 3) { // 텍스트 노드
              $(this).remove();
            }
          });

          // 새 텍스트 추가
          $treeLink.prepend(inputValue);

          // code가 있으면 다시 추가
          if (codeHtml) {
            $treeLink.append(' ' + codeHtml);
          }

          $treeLink.show();
          $editForm.remove();
        }
      });

      // 취소 버튼 클릭
      $editForm.find('.btn-cancel').on('click', function (e) {
        e.stopPropagation();
        $treeLink.show();
        $editForm.remove();
      });

      // Enter 키 처리
      $input.on('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          $editForm.find('.btn-add').click();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          $editForm.find('.btn-cancel').click();
        }
      });
    });
  }
</script>